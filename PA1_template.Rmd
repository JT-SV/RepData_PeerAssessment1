---
title: "Reproducible Research Peer Assessment 1"
author: "JT"
date: "June 25, 2017"
output: 
  html_document:
    keep_md:
      true
---

## Loading and preprocessing the data

```{r read_data_removing_nas}
setwd("~/ds/ReproducibleResearch/Week2/RepData_PeerAssessment1")
data<-read.csv(unz("activity.zip","activity.csv"),stringsAsFactors = FALSE)
d_clean<-data[!is.na(data$steps),]
```
## What is mean total number of steps taken per day?

```{r steps_per_day}
# Aggregate by day (i.e. date), then plot histogram
d_date<-aggregate(d_clean$steps,list(d_clean$date),mean)
names(d_date)<-c("date","steps")
hist(d_date$steps,main="Average Steps Per Day",xlab="Steps")
```

Summary measures for the average number of steps per day:
```{r summary_average_steps}
m<-mean(d_date$steps)
md<-median(d_date$steps)
```

The mean number of average steps per day is `r m`.  
The median number of average steps per day is `r md`.  

## What is the average daily activity pattern?

``` {r average_daily_pattern}
# Aggregate across days by interval, then plot
d_int<-aggregate(d_clean$steps,list(d_clean$interval),mean)
names(d_int)<-c("interval","steps")
with(d_int,plot(interval,steps,type="l",xlab="5-minute Interval",ylab="Steps",
                main="Average Number of Steps per Interval"))
```

So, which interval contains the maximum number of steps?
```{r calculate_max_steps}
max_index<-which.max(d_int$steps)
max_interval<-d_int[max_index,"interval"]
max_steps<-d_int[max_index,"steps"]
```

Interval `r max_interval` contains the maximum average number of steps: `r max_steps`. I.e the 5-minute interval starting at 8:35 in the morning.

## Imputing missing values

```{r missing_data}
d_na<-data[is.na(data$steps),]
n_na<-dim(d_na)[1]
```

There are `r n_na` rows with NA in the data set.

Impute the missing step values using the average steps for the interval, performing some checks as well:

```{r impute_data}
# For each row d in d_na, set steps to average steps for the interval (stored in d_int)
d_na["steps"]<- d_int$steps[match(d_na$interval,d_int$interval)]
# Re-construct the data set by merging clean with imputed 
d_complete<-rbind(d_clean,d_na)
# Reorder
d_complete<-d_complete[order(as.numeric(row.names(d_complete))),]
```

``` {r check_imputed}
# Confirm it all looks good. First the original data
head(data,n=3)
# Then the aggregated-by interval data which is used to fill in the NAs
d_int[d_int$interval %in% c(0,5,10),]
# Here is the result in the "complete" dataset
head(d_complete,n=3)
# Now check one data point in original vs "complete" for un-imputed data - looks good
rbind(data[800,],d_complete[800,])
```

Now the summary measures and the  histogram
``` {r complete_hist}
#Aggregate the "complete" dataset by day (date), then plot a histogram
d_complete_date<-aggregate(d_complete$steps,list(d_complete$date),mean)
names(d_complete_date)<-c("date","steps")
hist(d_complete_date$steps,
     main="Average steps per day (Missing Data Imputed)",xlab="Steps")

```

``` {r summary_measures}
m<-mean(d_complete_date$steps)
md<-median(d_complete_date$steps)
```

The mean number of average steps per day is `r m`.  
The median number of average steps per day is `r md`. 
The means are identical in the unimputed and imputed datasets, not so the median, which has changed a tiny bit.

As a double check, let's look at the data underlying the calculated means.  They differ, though the calculated means do not:
``` {r double_check}
matrix(c(sum(d_date$steps),sum(d_complete_date$steps),dim(d_date)[1],dim(d_complete_date)[1]),c(2,2))
all.equal(sum(d_complete_date$steps)/dim(d_complete_date)[1],
          sum(d_date$steps)/dim(d_date)[1])
```
The sums and counts differ between complete and original calculations but the equality of the means holds (by several decimal places) so it doesn't look like a problem.

## Are there differences in activity patterns between weekdays and weekends?

It appears so... The number of steps is higher throughout the day during the weekends.  The opposite is true in the mornings.
``` {r weekends}
library(lattice)
# Define a weekday vs. weekend function and a new column in the data
wd<-function(d){ d<-weekdays(as.Date(d))
    if (d=="Saturday"|d=="Sunday"){"Weekend"}else{"Weekday"}}
d_complete["weekday"]<-sapply(d_complete$date,wd)

# Aggregate by weekday/weekend and interval.  Plot.
d_final<-aggregate(d_complete$steps,list(d_complete$weekday,d_complete$interval),mean)
names(d_final)<-c("weekday","interval","steps")
xyplot(steps~interval|weekday,type="l",layout=c(1,2),ylab="Steps",xlab="Interval",
       data=d_final)

```
